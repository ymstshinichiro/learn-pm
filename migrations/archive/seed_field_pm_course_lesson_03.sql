-- 現場型プロジェクトマネジメントコース: レッスン3
-- 現場進捗計画の立案とガントチャート・工程表の活用

DO $$
DECLARE
  v_course_id INT;
  v_lesson_id INT;
BEGIN
  -- コースIDを取得
  SELECT id INTO v_course_id FROM courses WHERE slug = 'field-pm';

  -- レッスン3を挿入
  INSERT INTO lessons (course_id, slug, title, content, "order", created_at)
  VALUES (
    v_course_id,
    'schedule-planning-gantt',
    '現場進捗計画の立案とガントチャート・工程表の活用',
    $CONTENT$# 現場進捗計画の立案とガントチャート・工程表の活用

## 📋 このレッスンで学ぶこと

工期管理の要は「計画」と「進捗管理」です。本レッスンでは、ガントチャートや工程表を使った実践的な工程計画の立て方、クリティカルパスの把握、進捗管理の手法を学びます。

---

## 🎯 工程計画の基本

### 工程計画の目的

1. **納期達成**: 顧客との約束を守る
2. **リソース最適化**: 人員・設備を効率的に配置
3. **リスク管理**: 余裕（バッファ）を確保
4. **関係者調整**: 協力会社間の作業タイミング調整

### 工程計画の原則

| 原則 | 内容 |
|-----|------|
| **現実性** | 過去実績に基づく、達成可能な計画 |
| **詳細性** | 日単位・工程単位で具体的に |
| **柔軟性** | 天候・トラブルに対応できる余裕 |
| **可視性** | 誰が見ても分かる図表化 |

---

## 📊 ガントチャートの作成

### ガントチャートとは

時間軸（横軸）に対して、各作業（縦軸）の開始日・終了日を棒グラフで表現したもの。

```
作業           1月  2月  3月  4月
━━━━━━━━━━━━━━━━━━━━━━━━
基礎工事       ■■■
躯体工事           ■■■■■
電気配線               ■■■
内装工事                 ■■■■
検査・引渡                    ■
```

### ガントチャート作成の手順

#### ステップ1: WBS（Work Breakdown Structure）作成

プロジェクト全体を小さな作業単位に分解します。

```
【建物改修プロジェクトのWBS例】
1. 準備工事
   1.1 仮設事務所設置
   1.2 仮設電源・水道
   1.3 資材搬入路確保

2. 解体工事
   2.1 内装解体
   2.2 設備撤去
   2.3 廃材処分

3. 躯体工事
   3.1 補強工事
   3.2 防水工事

4. 設備工事
   4.1 電気配線
   4.2 給排水配管
   4.3 空調ダクト

5. 内装工事
   5.1 壁・天井仕上げ
   5.2 床仕上げ
   5.3 建具取付

6. 検査・引渡
   6.1 社内検査
   6.2 顧客検査
   6.3 引渡・清掃
```

#### ステップ2: 各作業の所要日数を見積もる

**見積もり手法**:
- **過去実績**: 類似案件のデータを参照
- **標準歩掛かり**: 業界標準の作業量
- **専門家判断**: ベテラン作業員の経験

**例**:
```
基礎工事: 10日（過去実績8-12日 → 余裕を見て10日）
躯体工事: 20日（標準歩掛かり + 天候バッファ2日）
```

#### ステップ3: 作業の依存関係を整理

| 依存関係 | 説明 | 例 |
|---------|------|---|
| **終了-開始（FS）** | Aが終わってからBを開始 | 基礎工事 → 躯体工事 |
| **開始-開始（SS）** | Aが始まったらBも開始 | 電気配線 ↔ 配管工事（並行） |
| **終了-終了（FF）** | Aが終わるときBも終わる | 検査 ↔ 是正工事 |
| **開始-終了（SF）** | Aが始まったらBを終わらせる | （稀） |

#### ステップ4: ガントチャートに配置

各作業を時間軸上に配置し、依存関係を矢印で結びます。

---

## 🛤️ クリティカルパス法（CPM）

### クリティカルパスとは

プロジェクト全体の工期を決定する「最長経路」です。

**特徴**:
- クリティカルパス上の作業が1日遅れると、全体が1日遅れる
- クリティカルパス外の作業には「余裕（フロート）」がある

### クリティカルパスの計算例

```
【ネットワーク図】
         B(20日)
        /        \
A(10日)→          → E(15日) → F(5日)
        \        /
         C(10日) → D(10日)

経路1: A → B → E → F = 10+20+15+5 = 50日
経路2: A → C → D → E → F = 10+10+10+15+5 = 50日

※ どちらも50日で同じ → 両方がクリティカルパス
```

### フロート（余裕時間）

**トータルフロート**: その作業が遅れてもプロジェクト全体に影響しない最大日数

```
例: 外構工事（10日、フロート5日）
→ 5日遅れても全体工期には影響しない
→ 6日遅れると全体が遅れる
```

### クリティカルパス管理の実践

#### 1. クリティカルパス上の作業を最優先

- リソース（人員・設備）を優先配分
- 遅延リスクを早期に検知
- 遅延時は即座に対策（クラッシング、ファストトラック）

#### 2. フロートのある作業でバッファ確保

- クリティカルパス上で問題発生時、フロートのある作業から人員を回す
- 天候不良時はフロートのある作業を優先実施

---

## 📅 工程表の種類と使い分け

### 1. バーチャート（ガントチャート）

**特徴**: シンプルで分かりやすい、作業期間が一目瞭然

**用途**: 全体工程の共有、現場掲示

**メリット**: 直感的、作成が容易

**デメリット**: 作業間の依存関係が分かりにくい

### 2. ネットワーク工程表

**特徴**: 作業間の依存関係を矢印で明示、クリティカルパス可視化

**用途**: 詳細な工程分析、工期短縮検討

**メリット**: 依存関係明確、クリティカルパス把握

**デメリット**: 複雑、作成に時間がかかる

### 3. 出来高累計曲線（Sカーブ）

**特徴**: 累積出来高を時間軸でプロット、S字型の曲線になる

```
出来高
100% ┤                     ／
     │                   ／
 50% ┤              ／／
     │          ／／
  0% └──────────────────→ 時間
     開始                終了

初期: ゆっくり（準備）
中期: 急速（本格施工）
後期: ゆっくり（仕上げ・検査）
```

**用途**: 進捗管理、EVM（Earned Value Management）

**メリット**: 進捗の遅れ・進みが視覚的に分かる

### 4. 週間工程表

**特徴**: 1週間単位の詳細工程、日単位で作業を記載

**用途**: 現場の日々の作業指示

**メリット**: 具体的、短期の調整に強い

---

## 📈 進捗管理の実践

### 進捗管理のサイクル

```
計画（Plan）
   ↓
実行（Do）
   ↓
測定（Check）: 実績を記録
   ↓
是正（Act）: 遅延時の対策
   ↓
（繰り返し）
```

### 進捗測定の手法

#### 1. 出来高の測定

| 手法 | 説明 | 例 |
|-----|------|---|
| **物理的出来高** | 完成した量を測定 | 配管100m中80m完了 → 80% |
| **マイルストーン法** | 完了時点のみカウント | 基礎工事完了 → 100%、未完了 → 0% |
| **50-50法** | 着手50%、完了50% | 着手時に50%、完了時に100% |

#### 2. 進捗率の算出

```
進捗率 = 実績出来高 / 計画出来高 × 100%

例:
計画: 3週間で配管工事100m完了
実績: 2週間経過時点で60m完了

計画出来高（2週間時点）: 100m × (2/3) = 66.7m
実績出来高: 60m
進捗率: 60 / 66.7 × 100% = 90%

→ 計画より10%遅れている
```

### 遅延時の対策

#### 軽微な遅延（1-3日）

- 残業・休日出勤で挽回
- 後工程の準備を前倒し

#### 中程度の遅延（1週間程度）

- クラッシング（人員増強）
- 並行作業の拡大（ファストトラック）
- 工法変更の検討

#### 重大な遅延（2週間以上）

- 全体工程の見直し
- 顧客と納期再交渉
- スコープの調整（優先順位の見直し）

---

## 🌦️ 天候対策とバッファ管理

### 天候リスクの考慮

**地域・季節による天候バッファ**:
```
梅雨時期（6-7月）: 10-15%のバッファ
台風シーズン（8-9月）: 10%のバッファ
冬季（12-2月）: 積雪地域は15-20%のバッファ
```

### バッファの配置戦略

#### 1. プロジェクトバッファ

全体の最後に予備期間を設ける

```
計画工期: 50日
バッファ: 5日
契約納期: 55日
```

#### 2. フィーディングバッファ

クリティカルパスに合流する前にバッファを配置

```
非クリティカル作業 → バッファ → クリティカルパス
```

---

## 🔧 工程管理ツール

### デジタルツールの活用

| ツール | 特徴 | 用途 |
|-------|------|------|
| **Microsoft Project** | 本格的な工程管理 | 大規模プロジェクト |
| **Excel** | 汎用性が高い | 中小規模、簡易管理 |
| **Asana / Trello** | タスク管理に強い | チーム協働 |
| **現場専用アプリ** | 写真・報告と連携 | 現場での進捗入力 |

### アナログ管理の価値

**現場掲示板**:
- 大きな工程表を現場事務所に掲示
- 毎日の進捗を手書きで更新
- 全員が「今どこにいるか」を共有

**メリット**:
- デジタルに不慣れな職人も把握できる
- 現場での即座の情報共有
- 視覚的インパクト

---

## ⚠️ よくある失敗パターン

### 失敗パターン1: 楽観的な計画

**症状**: 常に遅延、バッファがない

**原因**: 過去実績を無視、最短時間で計画

**対策**: 過去の平均値+10-15%のバッファ

### 失敗パターン2: クリティカルパスの見誤り

**症状**: 優先順位を間違え、全体が遅延

**原因**: クリティカルパスを特定していない

**対策**: CPM分析を実施、定期的に見直し

### 失敗パターン3: 進捗報告が曖昧

**症状**: 「順調です」と言いながら実は遅延

**原因**: 定量的な測定をしていない

**対策**: 出来高を数値化、進捗率を算出

---

## 🎓 まとめ

工程管理の成功は、「現実的な計画」と「定量的な進捗管理」にあります。

### 成功のための5つのポイント

1. **過去実績に基づく現実的な計画**: 楽観を排除
2. **クリティカルパスの把握**: 優先順位を明確に
3. **バッファの確保**: 天候・トラブルに備える
4. **定量的な進捗測定**: 出来高を数値化
5. **早期の是正措置**: 遅延の兆候を見逃さない

工程表は「作って終わり」ではなく、日々更新し、チーム全体で共有する「生きた道具」として活用しましょう。
$CONTENT$,
    3,
    NOW()
  ) RETURNING id INTO v_lesson_id;

  -- レッスン3の質問を挿入
  INSERT INTO questions (lesson_id, type, question, options, correct_answer, explanation, "order", created_at)
  VALUES
    -- 質問1: クリティカルパスの理解
    (v_lesson_id, 'multiple-choice', 'プロジェクト全体の工期が50日で、ある作業Xの所要日数は10日、フロートが5日ある場合、作業Xについて正しい記述はどれですか？',
     ARRAY['作業Xはクリティカルパス上にあり、1日遅れると全体が1日遅れる',
           '作業Xは5日まで遅れても全体工期に影響せず、6日遅れると全体が遅れ始める',
           '作業Xはフロートがあるため優先度が低く、リソースを他の作業に回すべき',
           '作業Xのフロート5日を使い切れば、全体工期を5日短縮できる'],
     ARRAY['作業Xは5日まで遅れても全体工期に影響せず、6日遅れると全体が遅れ始める'],
     'Aは誤りで、フロートがある作業はクリティカルパス外です（クリティカルパス上の作業はフロート0）。Cは誤りで、フロートがあっても「優先度が低い」わけではなく、あくまで「余裕がある」だけです。リソース配分は作業の重要性や依存関係で判断します。Dは誤りで、フロートは「遅れても良い余裕」であり、使い切っても工期短縮にはなりません。Bが正解で、フロート5日は「この作業が5日遅れても、他の作業に影響しない余裕時間」を意味します。6日遅れるとフロートを超過し、クリティカルパスに影響します。',
     1, NOW()),

    -- 質問2: 工程計画の現実性
    (v_lesson_id, 'multiple-choice', '過去の類似案件では基礎工事に8-12日かかっていた。今回の工程計画で基礎工事の所要日数として最も適切なのはどれですか？',
     ARRAY['最短の8日で計画し、効率化を図ることでモチベーションを高める',
           '平均の10日で計画し、標準的な工期を設定する',
           '平均の10日に天候バッファ2日を加えた12日で計画する',
           '最長の12日で計画し、余裕を持たせる'],
     ARRAY['平均の10日に天候バッファ2日を加えた12日で計画する'],
     'Aの最短8日は楽観的すぎて、天候不良や想定外で遅延する可能性が高く、現実的ではありません。Bの平均10日は一見妥当ですが、バッファがないため天候不良時に即座に遅延します。Dの最長12日は過度に保守的で、「どうせ余裕がある」と作業ペースが緩む可能性があります。Cが正解で、過去の平均値（10日）を基準とし、天候や想定外のトラブルに備えた適度なバッファ（2日）を加えます。現場の原則は「現実的な目標+適度なバッファ」です。',
     2, NOW()),

    -- 質問3: 遅延対策の優先順位
    (v_lesson_id, 'multiple-choice', '全体工期50日のプロジェクトで、20日経過時点で5日の遅延が判明した。最も適切な対応はどれですか？',
     ARRAY['全体工程を見直し、クリティカルパス上の作業を優先的に加速（クラッシング）し、フロートのある作業でバッファを確保する',
           'すべての作業で残業を増やし、全体的に加速して遅れを取り戻す',
           '品質検査を簡素化し、検査時間を短縮して工期を圧縮する',
           '顧客に即座に報告し、納期を5日延長してもらう交渉を開始する'],
     ARRAY['全体工程を見直し、クリティカルパス上の作業を優先的に加速（クラッシング）し、フロートのある作業でバッファを確保する'],
     'Bの全作業で残業増は非効率で、コスト増・疲労蓄積・安全リスク増を招きます。クリティカルパス外の作業を加速しても全体工期は短縮しません。Cの品質検査簡素化は品質不良を見逃し、後の瑕疵対応で更なる遅延・コスト増を招きます。Dの即座の納期延長交渉は、まず社内での挽回策を検討してからでも遅くありません（5日程度なら挽回可能）。Aが正解で、クリティカルパスを再確認し、そこに集中してリソース投入（クラッシング）、フロートのある作業は後回しまたは人員を回します。効率的な遅延対策の鉄則は「クリティカルパスに集中」です。',
     3, NOW()),

    -- 質問4: バッファの配置
    (v_lesson_id, 'multiple-answer', '工程計画でバッファ（予備期間）を確保する方法として適切なものはどれですか？（複数選択）',
     ARRAY['プロジェクト全体の最後に5-10%の予備期間を設け、想定外の遅延に備える',
           '各作業の所要日数を過去平均より10-15%長めに見積もり、作業レベルでバッファを内包する',
           'クリティカルパスに合流する非クリティカル作業の後にフィーディングバッファを配置し、遅延の波及を防ぐ',
           'バッファは甘えを生むため設けず、最短工期で計画して緊張感を持たせる'],
     ARRAY['プロジェクト全体の最後に5-10%の予備期間を設け、想定外の遅延に備える', '各作業の所要日数を過去平均より10-15%長めに見積もり、作業レベルでバッファを内包する', 'クリティカルパスに合流する非クリティカル作業の後にフィーディングバッファを配置し、遅延の波及を防ぐ'],
     'A、B、Cが正解です。Aのプロジェクトバッファは全体レベルの予備期間で、最終段階での調整に使えます。Bの作業レベルバッファは、過去実績に基づく現実的な見積もりであり、天候・小トラブルへの備えです。Cのフィーディングバッファは、非クリティカル作業の遅延がクリティカルパスに波及しないための緩衝帯です。Dは誤りで、バッファなしは「計画通りに行かない現場」では必ず遅延を招きます。適度なバッファは「甘え」ではなく「リスク管理」です。',
     4, NOW()),

    -- 質問5: 進捗測定の方法
    (v_lesson_id, 'multiple-choice', '「配管工事100m、3週間」という計画で、2週間経過時点での進捗を評価する方法として最も適切なのはどれですか？',
     ARRAY['作業責任者に「順調ですか？」と聞き、「順調です」と答えたら問題なしと判断する',
           '実際に完了した配管の長さを測定し、計画出来高（66.7m）と比較して進捗率を算出する',
           '2週間 / 3週間 = 66.7%の進捗と見なし、計画通りと判断する',
           '配管工事が完了していなければ進捗0%、完了していれば100%とする（マイルストーン法）'],
     ARRAY['実際に完了した配管の長さを測定し、計画出来高（66.7m）と比較して進捗率を算出する'],
     'Aの主観的評価は、作業者の楽観や報告のしづらさにより、実態と乖離することが多く信頼できません。Cの時間比率だけでは「実際の作業がどこまで進んだか」が不明で、進捗の遅れ・進みを検知できません。Dのマイルストーン法（0%か100%）は、長期作業では途中経過が見えず、終盤まで遅延に気づかないリスクがあります。Bが正解で、物理的出来高（実際に完了した配管の長さ）を測定し、計画出来高と比較することで、定量的に進捗を評価できます。進捗管理の鉄則は「測定可能な指標で定量評価」です。',
     5, NOW());

END $$;
