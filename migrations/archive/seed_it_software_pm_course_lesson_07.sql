-- IT・ソフトウェア開発プロジェクトマネジメントコース
-- Lesson 7: リスクマネジメントと課題管理

DO $$
DECLARE
  v_course_id INT;
  v_lesson_id INT;
BEGIN
  -- Get course ID
  SELECT id INTO v_course_id FROM courses WHERE slug = 'it-software-pm';

  -- Lesson 7: リスクマネジメントと課題管理
  INSERT INTO lessons (course_id, slug, title, content, "order", created_at)
  VALUES (
    v_course_id,
    'risk-issue-management',
    'リスクマネジメントと課題管理',
    $CONTENT$# リスクマネジメントと課題管理

リスクマネジメントは、**不確実性を管理し、プロジェクトの成功確率を高める**プロアクティブなアプローチです。

## リスクと課題の違い

### 定義の明確化

| 項目 | リスク（Risk） | 課題（Issue） |
|------|--------------|-------------|
| **時制** | 将来起こるかもしれない | 既に起きている |
| **性質** | 不確実性 | 確実性 |
| **対応** | 予防・軽減 | 解決・対処 |
| **確率** | < 100% | 100% |

**例：**
- ❌ **リスク：** 「主要エンジニアが退職する可能性がある」
- ✅ **課題：** 「主要エンジニアが退職した」

### リスクが課題になる瞬間

```
リスクの特定 → リスク対策 → [リスクが顕在化] → 課題として管理
     ↓              ↓                               ↓
  予防的対応      軽減策実施                    問題解決
```

## リスクマネジメントプロセス

### 1. リスクの特定

#### リスク特定の手法

**ブレインストーミング：**
- 👥 チーム全体でリスクを洗い出し
- 💬 批判せず自由に発想
- 📝 全てのアイデアを記録

**チェックリスト法：**
- 📋 過去のプロジェクトからリスクカタログ作成
- ✅ 体系的に確認

**SWOT分析：**
- 💪 Strengths（強み）
- 😓 Weaknesses（弱み）
- 🌟 Opportunities（機会）
- ⚠️ Threats（脅威）

**専門家インタビュー：**
- 🎤 経験豊富なメンバーへのヒアリング
- 📊 ドメイン知識の活用

#### ITプロジェクト特有のリスクカテゴリ

| カテゴリ | リスク例 |
|---------|---------|
| **技術リスク** | 新技術の習得不足、性能目標未達、技術的実現可能性 |
| **人的リスク** | キーパーソンの離脱、スキル不足、チーム内対立 |
| **要件リスク** | 要件の曖昧性、スコープクリープ、ステークホルダーの意見対立 |
| **スケジュールリスク** | 見積もり誤差、依存関係の遅延、リソース不足 |
| **外部リスク** | ベンダー遅延、外部API変更、法規制変更 |
| **セキュリティリスク** | 脆弱性、データ漏洩、サイバー攻撃 |

### 2. リスクの分析

#### 定性的リスク分析

**確率と影響度のマトリクス：**

```
        高影響
         ↑
    中   |   高    リスクレベル
 低─────┼─────高  発生確率
    低   |   中
         ↓
        低影響
```

**評価スケール：**

| 確率 | 定義 | 数値 |
|------|------|------|
| 高 | 70%以上 | 3 |
| 中 | 30-70% | 2 |
| 低 | 30%未満 | 1 |

| 影響 | 定義 | 数値 |
|------|------|------|
| 高 | スケジュール1ヶ月以上遅延、コスト20%以上増 | 3 |
| 中 | スケジュール1-4週間遅延、コスト10-20%増 | 2 |
| 低 | スケジュール1週間未満遅延、コスト10%未満増 | 1 |

**リスクスコア = 確率 × 影響度**

**優先順位付け：**
- 🔴 **高リスク（7-9）：** 即座に対策
- 🟡 **中リスク（4-6）：** 計画的に対策
- 🟢 **低リスク（1-3）：** 監視

#### 定量的リスク分析

**期待金額価値（EMV: Expected Monetary Value）：**

EMV = 確率 × 影響額

**例：**
- リスク：サーバー障害
- 確率：20%
- 影響：500万円の損失
- EMV = 0.2 × 500万 = 100万円

→ 100万円以下の対策なら投資価値あり

**三点見積もり：**
- 📊 楽観値（O）、最頻値（M）、悲観値（P）
- 🎯 期待値 = (O + 4M + P) / 6
- 📈 標準偏差 = (P - O) / 6

**モンテカルロシミュレーション：**
- 🎲 確率分布に基づくシミュレーション
- 📊 プロジェクト完了日の確率分布を算出

### 3. リスク対応計画

#### 4つのリスク対応戦略

**1. 回避（Avoid）**
- 🚫 リスクの原因を排除
- 例：未経験技術の使用を中止 → 実績ある技術を採用

**2. 軽減（Mitigate）**
- 📉 確率または影響度を下げる
- 例：スキル不足リスク → トレーニング実施

**3. 転嫁（Transfer）**
- 🔄 第三者にリスクを移転
- 例：技術リスク → 専門ベンダーに外注

**4. 受容（Accept）**
- ✅ リスクを受け入れる
- 🎯 **能動的受容：** コンティンジェンシー予備を確保
- 💤 **受動的受容：** 何もしない（低リスクの場合）

#### リスク対応計画の要素

**各リスクに対して：**
1. 📋 **リスクオーナー：** 誰が監視・対応するか
2. 🎯 **対応戦略：** 回避・軽減・転嫁・受容
3. 📝 **具体的アクション：** 何をするか
4. 💰 **予算：** コンティンジェンシー予備
5. 🔔 **トリガー：** どうなったら対応開始するか
6. 🔄 **コンティンジェンシープラン：** リスクが顕在化した際の対応

**例：**
```
リスク：主要エンジニアAの退職
確率：30% / 影響：高 / リスクスコア：6
オーナー：PM
対応戦略：軽減
アクション：
  - 知識共有セッションを週1回実施
  - ドキュメント整備
  - バックアップ担当者Bの育成
予算：トレーニング費50万円
トリガー：Aが転職活動を開始した兆候
コンティンジェンシー：外部専門家の短期契約（月200万円）
```

### 4. リスクの監視とコントロール

#### 定期的なリスクレビュー

**頻度：**
- 🔄 週次：高リスクの状態確認
- 📅 月次：全リスクの見直し
- 🎯 マイルストーン：リスク再評価

**確認事項：**
- ✅ トリガーが発生したか
- 📊 確率・影響度に変化はないか
- 🆕 新たなリスクは発生していないか
- 🎯 対策は効果を出しているか

#### リスク指標

**リスクバーンダウン：**
- 📉 時間経過とともにリスクスコア合計が減少
- 🎯 対策の効果を可視化

**リスクの数：**
- 🔴 高リスク数
- 🟡 中リスク数
- 🟢 低リスク数

## 課題（Issue）管理

### 課題のライフサイクル

```
新規登録 → 分析・割当 → 対応中 → 解決 → クローズ
                               ↓
                            再オープン
```

### 課題管理の要素

**課題票に含めるべき情報：**

1. **基本情報**
   - 🆔 課題ID
   - 📝 タイトル
   - 📄 詳細説明

2. **分類**
   - 🏷️ カテゴリ（技術・要件・リソースなど）
   - 🔴 優先度（P1/P2/P3/P4）
   - ⚠️ 重要度（High/Medium/Low）

3. **責任**
   - 👤 起票者
   - 👤 担当者
   - 📊 ステータス

4. **スケジュール**
   - 📅 発生日
   - ⏰ 期限
   - ✅ 解決日

5. **対応**
   - 📝 対応内容
   - 🔗 関連情報・リンク

### 課題の優先順位付け

#### アイゼンハワーマトリクス

```
      重要
       ↑
  Q1   |   Q2
緊急───┼───非緊急
  Q3   |   Q4
       ↓
     重要でない
```

| 象限 | 特徴 | 対応 |
|------|------|------|
| **Q1（緊急×重要）** | クリティカルな問題 | 即座に対応 |
| **Q2（非緊急×重要）** | 戦略的な課題 | 計画的に対応 |
| **Q3（緊急×重要でない）** | 割り込み作業 | 委譲または最小化 |
| **Q4（非緊急×重要でない）** | 雑務 | 後回しまたは削除 |

#### MoSCoW法（課題版）

- 🔴 **Must：** 今すぐ解決必須
- 🟠 **Should：** 早めに解決すべき
- 🟡 **Could：** できれば解決
- ⚪ **Won't：** 今は対応しない

### エスカレーション

#### エスカレーションの基準

**時間ベース：**
- ⏰ P1課題が24時間未解決
- ⏰ P2課題が1週間未解決

**影響ベース：**
- 🚨 複数システムに影響
- 💰 コスト増加が予算の10%超
- 📅 スケジュール遅延が1週間超

**能力ベース：**
- 🤷 担当者では解決不可
- 🔐 権限不足で意思決定できない

#### エスカレーションパス

```
レベル1：チームリーダー（～24時間）
    ↓
レベル2：プロジェクトマネージャー（～48時間）
    ↓
レベル3：部門長・スポンサー（～1週間）
    ↓
レベル4：経営層
```

## リスクと課題のレポーティング

### ダッシュボード

**含めるべきKPI：**

| 指標 | 説明 | 目標 |
|------|------|------|
| **高リスク数** | リスクスコア7-9のリスク | トレンドで減少 |
| **未解決課題数** | オープンな課題 | 増加トレンドなし |
| **P1課題の平均解決時間** | 緊急課題の対応速度 | < 24時間 |
| **リスクバーンダウン** | リスクスコア合計 | 時間とともに減少 |
| **コンティンジェンシー予備使用率** | 予備費の消費率 | < 50% |

### ステークホルダーへの報告

#### 報告の粒度

| 対象 | 内容 | 頻度 |
|------|------|------|
| **経営層** | 高リスク・高優先度課題のみ | 月次 |
| **スポンサー** | 中リスク以上、P2以上の課題 | 週次 |
| **プロジェクトチーム** | 全リスク・全課題 | 日次 |

#### RAG（Red/Amber/Green）ステータス

- 🔴 **Red：** 重大な問題、即座の対応が必要
- 🟡 **Amber：** 注意が必要、監視中
- 🟢 **Green：** 順調

## ITプロジェクト特有のリスクと対策

### 技術リスク

**リスク：新技術の習得不足**

対策：
- 📚 事前のPoC（Proof of Concept）実施
- 🎓 トレーニング・ハンズオン
- 👥 外部専門家のアドバイザリー契約
- 📊 技術スパイク（調査期間）の確保

**リスク：性能目標未達**

対策：
- 🧪 早期の性能テスト実施
- 📊 性能予測モデルの構築
- ⚡ パフォーマンスチューニング時間の確保
- 🔄 アーキテクチャレビュー

### 人的リスク

**リスク：キーパーソンの離脱**

対策：
- 📝 知識のドキュメント化
- 👥 ペアプログラミング・モブプログラミング
- 🔄 ローテーション・クロストレーニング
- 💰 リテンション施策（評価・報酬）

**リスク：チーム内対立**

対策：
- 🗣️ 定期的な1on1
- 🎯 チームビルディング活動
- 📋 明確な役割分担（RACI）
- 🤝 コンフリクト解決プロセス

### 外部依存リスク

**リスク：ベンダー遅延**

対策：
- 📋 SLA（Service Level Agreement）の明確化
- 🔍 定期的な進捗確認
- 🎯 マイルストーン支払い（成果報酬）
- 🔄 代替ベンダーの検討

**リスク：外部API変更**

対策：
- 🔔 API変更の通知設定
- 🛡️ アダプターパターンで疎結合化
- 📚 バージョン管理とテスト
- 🔄 代替APIの調査

## リスクマネジメントのベストプラクティス

### 1. リスクマネジメントを文化にする

- 🗣️ **オープンなコミュニケーション：** リスク報告を奨励
- 🚫 **非難しない文化：** リスク報告者を責めない
- 🎯 **プロアクティブ：** 問題が起きる前に対応

### 2. 定量化と可視化

- 📊 **メトリクスで管理：** 感覚ではなくデータで判断
- 📈 **トレンド分析：** 時系列での変化を追跡
- 🎨 **ダッシュボード：** 誰でも状況を把握できる

### 3. 継続的な改善

- 🔄 **振り返り：** プロジェクト終了時にリスク対応を評価
- 📚 **リスクカタログ：** 過去の知見を蓄積
- 🎓 **学習する組織：** 失敗から学ぶ

### 4. コンティンジェンシー予備の確保

**予備の種類：**

| 予備 | 用途 | 規模 |
|------|------|------|
| **コンティンジェンシー予備** | 既知のリスク対応 | 予算の10-20% |
| **マネジメント予備** | 未知のリスク対応 | 予算の5-10% |

**予備の管理：**
- 📊 使用状況の追跡
- ✅ 使用には承認プロセス
- 🔄 使用後は原因分析

### 5. リスクとチャンスの両面

**ポジティブリスク（機会）の管理：**

- 🌟 **活用（Exploit）：** 機会を確実にする
- 🎯 **強化（Enhance）：** 確率・影響を高める
- 🤝 **共有（Share）：** パートナーと機会を共有
- ✅ **受容（Accept）：** 特に何もしない

**例：**
- 機会：新技術採用で生産性30%向上の可能性
- 戦略：強化
- アクション：トレーニング投資、PoC実施で確実性を高める

💡 **リスクマネジメントは「問題を避ける」ことではなく、「不確実性をコントロールする」ことです。プロアクティブにリスクを特定・分析・対応し、課題が発生したら迅速に解決する。この両輪により、プロジェクトの成功確率を最大化します。**$CONTENT$,
    7,
    NOW()
  ) RETURNING id INTO v_lesson_id;

  -- Lesson 7: Questions (ひっかけ問題スタイル)
  INSERT INTO questions (lesson_id, type, question, options, correct_answer, explanation, "order", created_at)
  VALUES
    (v_lesson_id, 'multiple-choice', 'プロジェクトで「主要エンジニアが体調不良で1週間休んでいる」という状況は、リスクと課題のどちらとして管理すべきですか？',
     ARRAY['リスク - 将来復帰しない可能性があるため', '課題 - 既に発生しており、対応が必要なため', 'リスクと課題の両方 - 現在の欠員は課題、将来の退職はリスク', 'どちらでもない - 一時的な問題で管理不要'],
     ARRAY['課題 - 既に発生しており、対応が必要なため'],
     'Bが正解です。「既に休んでいる」は確実に起きている事象なので課題です。Aの「復帰しない可能性」は別のリスクとして管理すべき（「休職から退職に至るリスク」）。Cは混同しており、現時点の状況は課題として管理し、将来の退職リスクは別のリスク票で管理します。Dは誤りで、1週間の欠員は対応が必要です。リスクと課題の区別は「時制」が鍵で、既に起きたことは課題です。',
     1, NOW()),
    (v_lesson_id, 'multiple-answer', 'リスク対応戦略で「転嫁（Transfer）」が適切なケースを全て選択してください。',
     ARRAY['技術的実現可能性が不明な新技術の採用リスク → 専門ベンダーに開発を委託', 'サーバー障害によるサービス停止リスク → クラウドのSLA保証サービスを利用', 'チームのスキル不足リスク → トレーニングを実施して能力向上', '主要メンバーの退職リスク → 知識共有とドキュメント化を徹底'],
     ARRAY['技術的実現可能性が不明な新技術の採用リスク → 専門ベンダーに開発を委託', 'サーバー障害によるサービス停止リスク → クラウドのSLA保証サービスを利用'],
     'AとBが転嫁です。転嫁は「第三者にリスクを移転」することで、Aは専門ベンダーに技術リスクを移転、BはクラウドベンダーにSLA保証を求めることで障害リスクを移転しています。Cは「軽減」（トレーニングでスキル不足の確率を下げる）、Dも「軽減」（知識共有で退職時の影響を下げる）です。転嫁は保険・外注・SLAなどで第三者にリスクを移す戦略であり、自社での対策（トレーニング・ドキュメント）は軽減です。',
     2, NOW()),
    (v_lesson_id, 'multiple-choice', 'リスクの定量的分析で、EMV（期待金額価値）が100万円のリスクに対して、150万円のコストがかかる対策を実施する判断として最も適切なのはどれですか？',
     ARRAY['EMVよりコストが高いため、対策を実施すべきでない', '対策により影響度がゼロになるなら、実施を検討する価値がある', '高リスクなので、コストに関わらず必ず対策を実施すべき', 'EMVは参考値に過ぎないため、直感で判断すべき'],
     ARRAY['対策により影響度がゼロになるなら、実施を検討する価値がある'],
     'Bが正解です。EMV100万円は「確率×影響額」の期待値ですが、対策により確率を0%にできる（回避）、または影響額を大幅に削減できるなら、150万円の投資でも正当化できる場合があります。例：確率20%×影響500万円=EMV100万円でも、500万円の損失を避けられるなら150万円の投資は合理的です。Aは機械的すぎ、Cはコスト無視、DはEMV分析の意義を否定しています。EMVは判断材料の一つであり、影響の深刻さや戦略的重要性も考慮すべきです。',
     3, NOW()),
    (v_lesson_id, 'multiple-answer', '課題のエスカレーションを行うべき状況として適切なものを全て選択してください。',
     ARRAY['P2課題が発生したが、担当者が対応中で進捗している', 'P1課題が24時間経過しても解決せず、担当者だけでは対応困難', 'P3課題だが、複数のステークホルダーに影響があり、調整が必要', '担当者に解決の権限がなく、マネージャーの承認が必要'],
     ARRAY['P1課題が24時間経過しても解決せず、担当者だけでは対応困難', 'P3課題だが、複数のステークホルダーに影響があり、調整が必要', '担当者に解決の権限がなく、マネージャーの承認が必要'],
     'B、C、Dがエスカレーション対象です。Bは時間ベース（P1で24時間未解決）と能力ベース（担当者では対応困難）の両方に該当。Cは優先度は低いが影響範囲が広く、ステークホルダー調整に上位者が必要。Dは権限不足で意思決定できないケース。Aは順調に進捗しているためエスカレーション不要です。エスカレーションは「問題報告」ではなく「上位者の関与・判断が必要な状況」で行うべきで、全ての課題をエスカレーションすると本当に重要な問題が埋もれます。',
     4, NOW()),
    (v_lesson_id, 'multiple-choice', 'コンティンジェンシー予備（リスク予備）の使用について最も適切な方針はどれですか？',
     ARRAY['リスクが顕在化したら、PMの判断で自由に使用できる', '予備は「余裕」であり、スケジュール短縮のための追加リソース投入に使用できる', '特定したリスクが顕在化した場合にのみ使用し、使用には承認プロセスを設ける', '予備は使わないことが望ましいため、極力使用を避け、最終手段とする'],
     ARRAY['特定したリスクが顕在化した場合にのみ使用し、使用には承認プロセスを設ける'],
     'Cが正解です。コンティンジェンシー予備は「特定されたリスク」への対応資金であり、承認プロセスを経て使用すべきです。Aの「自由に使用」は統制不足、Bの「スケジュール短縮」は予備の目的外使用（それは通常予算で対応）、Dの「極力使用を避ける」は誤解で、リスクが顕在化したら適切に使用すべきです（使わないことが目的ではない）。予備は「安全装置」であり、必要なら使う、ただし使用理由を明確にし、承認を得ることが重要です。',
     5, NOW());

END $$;
